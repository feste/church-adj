(define (last lst)
  (first (fold (lambda (a lst) (append (list a) lst)) '() lst)))

;100 bins
(define bins
  (mem
   (lambda (item)
     (case item
           (('watch) '((1   3   5   7   9  11  13  15  17  19  21  23  25  27  29  31  33  35  37  39  41  43  45 47  49  51  53  55  57  59  61  63  65  67  69  71  73  75  77  79  81  83  85  87  89  91 93  95  97  99 101 103 105 107 109 111 113 115 117 119 121 123 125 127 129 131 133 135 137 139 141 143 145 147 149 151 153 155 157 159 161 163 165 167 169 171 173 175 177 179 181 183 185 187 189 191 193 195 197 199 201 203 205 207 209 211 213 215 217 219 221 223 225 227 229 231 233 235 237 239 241 243 245 247 249 251 253 255 257 259 261 263 265 267 269 271 273 275 277 279 281 283 285 287 289 291 293 295 297 299 301 303 305 307 309 311 313 315 317 319 321 323 325 327 329 331 333 335 337 339 341 343 345 347 349 351 353 355 357 359 361 363 365 367 369 371 373 375 377 379 381 383 385 387 389 391 393 395 397 399 401 403 405 407 409 411 413 415 417 419 421 423 425 427 429 431 433 435 437 439 441 443 445 447 449 451 453 455 457 459 461 463 465 467 469 471 473 475 477 479 481 483 485 487 489 491 493 495 497 499 501 503 505 507 509 511 513 515 517 519 521 523 525 527 529 531 533 535 537 539 541 543 545 547 549 551 553 555 557 559 561 563 565 567 569 571 573 575 577 579 581 583 585 587 589 591 593 595 597 599 601 603 605 607 609 611 613 615 617 619 621 623 625 627 629 631 633 635 637 639 641 643 645 647 649 651 653 655 657 659 661 663 665 667 669 671 673 675 677 679 681 683 685 687 689 691 693 695 697 699 701 703 705 707 709 711 713 715 717 719 721 723 725 727 729 731 733 735 737 739 741 743 745 747 749 751 753 755 757 759 761 763 765 767 769 771 773 775 777 779 781 783 785 787 789 791 793 795 797)
                       (0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.04539462 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05738133 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.05990456 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06464303 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06308238 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.06109983 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05582731 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.05023368 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04520400 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.04418568 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03552839 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.03190200 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02928082 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02710798 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02365619 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430 0.02211430)))
           (('coffee-maker) '((2   6  10  14  18  22  26  30  34  38  42  46  50  54  58  62  66  70  74  78  82  86  90  94 98 102 106 110)
                              (0.001975121 0.002082466 0.002175246 0.005900060 0.007492681 0.008124998 0.009697055 0.011488027 0.013437408 0.015420732 0.016235730 0.021550838 0.024096345 0.028279331 0.031908750 0.034132182 0.036432332 0.038974949 0.041349313 0.041160166 0.039922030 0.038105288 0.035703557 0.031103109 0.027592800 0.023886383 0.021524143 0.018387159)))
           (('sweater) '((1.5   4.5   7.5  10.5  13.5  16.5  19.5  22.5  25.5  28.5  31.5  34.5  37.5  40.5  43.5  46.5 49.5  52.5  55.5  58.5  61.5  64.5  67.5  70.5  73.5  76.5  79.5  82.5  85.5  88.5  91.5  94.5 97.5 100.5 103.5 106.5 109.5 112.5 115.5 118.5 121.5 124.5 127.5 130.5 133.5 136.5 139.5 142.5 145.5 148.5 151.5 154.5 157.5 160.5 163.5 166.5 169.5 172.5 175.5 178.5 181.5 184.5 187.5 190.5 193.5 196.5 199.5 202.5 205.5 208.5 211.5)
                         (0.002486955 0.004582076 0.004524160 0.005866771 0.008117919 0.010786412 0.015969214 0.020514657 0.022474976 0.024336248 0.024648874 0.025808881 0.026802326 0.026751866 0.026810012 0.024971170 0.024659059 0.024533304 0.025112112 0.024962700 0.027237394 0.025329356 0.024216808 0.024563002 0.023323976 0.023535326 0.022454318 0.020961860 0.020949777 0.020030631 0.019803825 0.019425430 0.018967818 0.019640079 0.020045374 0.019802907 0.019116057 0.017606519 0.016252240 0.015618704 0.014712515 0.013149716 0.012603768 0.011082980 0.010440336 0.010249414 0.007613572 0.007887591 0.007796492 0.006531850 0.006174117 0.005935423 0.005528811 0.005866038 0.005848424 0.005431285 0.005745163 0.005127271 0.005311754 0.005613683 0.004375860 0.003705030 0.003172852 0.003164310 0.002884658 0.003384829 0.002660608 0.002712844 0.002663500 0.002715235 0.001674627)))
           (('laptop) '((25   75  125  175  225  275  325  375  425  475  525  575  625  675  725  775  825  875  925 975 1025 1075 1125 1175 1225 1275 1325 1375 1425 1475 1525 1575 1625 1675 1725 1775 1825 1875 1925 1975 2025 2075 2125 2175 2225 2275 2325 2375 2425 2475)
                        (0.001064007 0.001358183 0.002482445 0.005813405 0.005692352 0.007513110 0.010242988 0.012060446 0.017217258 0.025724876 0.029070659 0.030873911 0.033816333 0.035004769 0.036650937 0.036329716 0.039088340 0.039402108 0.037017048 0.037441721 0.036164364 0.033427937 0.030756604 0.028541803 0.027272937 0.025611587 0.024687448 0.022785161 0.022344506 0.021037432 0.019986076 0.020625414 0.019452562 0.018945851 0.018821152 0.018699490 0.017536793 0.016747552 0.017245179 0.015554097 0.013781324 0.011860045 0.009848702 0.010007491 0.010126634 0.009964694 0.009447235 0.008974418 0.008286553 0.007594347)))
           (('headphones) '((3  9 15 21 27 33 39 45 51 57 63 69 75 81)
                            (0.00950570 0.01385440 0.02171737 0.03284306 0.04272055 0.04455260 0.04438232 0.04108967 0.03831715 0.03488201 0.03542911 0.03429350 0.03107974 0.02539518)))))))

;\(([0-9.]+ *)+\)
;\n *\[[0-9]+\] *

(define (prior item) (apply multinomial (bins item)))
(define (theta-prior item) (uniform-draw (first (bins item))))

(define (utterance-prior) (multinomial '(expensive no-utt) '(0.3678794 1)))

(define pragmatic-listener
  (mem (lambda (utterance item)
         ;query price and theta given speaker would have said that
         (mh-query 30000 5
                   (define price (apply multinomial (bins item)))
                   (define theta (theta-prior item))
                   (list price theta)
                   (eq? (apply multinomial (speaker price theta item)) utterance)))))

(define speaker
  (mem (lambda (price theta item)
         ;query utterance given literal listener would guess price given theta
         (enumeration-query
          (define u (utterance-prior))
          u
          (eq? (apply multinomial (literal-listener u theta item)) price)))))

(define literal-listener
  (mem (lambda (u theta item)
         (define bin (bins item))
         (define (post-utterance)
           (define bin-pairs (map list
                                  (first bin)
                                  (second bin)))
           (define filtered-bin-pairs (fold
                                       (lambda (a lst) (if (>= (first a) theta)
                                                           (pair a lst)
                                                           lst))
                                       '()
                                       bin-pairs))
           (list (map first filtered-bin-pairs) (map second filtered-bin-pairs)))
         (if (eq? u 'expensive)
             (post-utterance)
             bin))))


(define sorites-model
  (mem
   (lambda (item)
     ;human data for comparison
     (define people (case item
                          (('watch) '(8.308824 8.454545 7.652778 6.826667 6.255319 5.750000))
                          (('laptop) '(8.394366 8.337838 7.179104 5.214286 4.550000 3.536585))
                          (('coffee-maker) '(8.554054 7.746269 6.613333 6.171875 5.150000 4.414634))
                          (('headphones) '(8.460526 7.985075 5.936508 5.337500 4.352941 4.045455))
                          (('sweater) '(8.655738 7.973684 7.027397 6.377049 5.179487 4.000000))))
     
     
     ;human standard deviations from experiment
     (define epsilons (map (lambda (e) (* e (case item
                                                  (('watch) 15.28736)
                                                  (('laptop) 254.2707)
                                                  (('coffee-maker) 22.31799)
                                                  (('headphones) 31.54902)
                                                  (('sweater) 15.28736))))
                           '(0.01 0.10 0.50 1.00 2.00 3.00)))
     
     ;results of model-
     (define samples (pragmatic-listener 'expensive item))
     (define prices (map first samples))
     (define thetas (map second samples))
     
     ;inductive premise
     (define (inductive e)
       (define lst (map (lambda (p t) (if (>= (- p e) t) 1 0)) prices thetas))
       ;get mean value of inductive premise
       (/ (apply + lst) (length lst)))
     
     (define model-judgements (map inductive epsilons))
     ;comparison: people to model
     (define people-vs-model (map pair
                                  people
                                  (map inductive epsilons)))
     (list people-vs-model
           model-judgements
           prices
           thetas))))

(define items '(watch
                laptop
                coffee-maker
                headphones
                sweater))

(define ppl-vs-mod (fold
                    append
                    '()
                    (map (lambda (item) (first (sorites-model item))) items)))

(list
 'watch
 (second (sorites-model 'watch))
 (mean (third (sorites-model 'watch)))
 (mean (fourth (sorites-model 'watch)))
 'laptop
 (second (sorites-model 'laptop))
 (mean (third (sorites-model 'laptop)))
 (mean (fourth (sorites-model 'laptop)))
 'coffee-maker
 (second (sorites-model 'coffee-maker))
 (mean (third (sorites-model 'coffee-maker)))
 (mean (fourth (sorites-model 'coffee-maker)))
 'headphones
 (second (sorites-model 'headphones))
 (mean (third (sorites-model 'headphones)))
 (mean (fourth (sorites-model 'headphones)))
 'sweater
 (second (sorites-model 'sweater))
 (mean (third (sorites-model 'sweater)))
 (mean (fourth (sorites-model 'sweater))))